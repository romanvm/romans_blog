function wrapCode(e){e.innerHTML="<code>"+e.innerHTML+"</code>"}function checkLineNumbers(e){var t=e.className.match(/line-numbers/);return null!=t}function isCodeSample(e){return e&&"PRE"==e.nodeName&&-1!==e.className.indexOf("language-")}function trimArg(e){return function(t,n){return e(n)}}function getLanguages(e){var t=[{text:"HTML/XML",value:"markup"},{text:"JavaScript",value:"javascript"},{text:"CSS",value:"css"},{text:"PHP",value:"php"},{text:"Ruby",value:"ruby"},{text:"Python",value:"python"},{text:"Java",value:"java"},{text:"C",value:"c"},{text:"C#",value:"csharp"},{text:"C++",value:"cpp"}],n=e.settings.codesample_languages;return n?n:t}function insertCodeSample(e,t,n,a){e.undoManager.transact(function(){var l=getSelectedCodeSample(e),o="";a&&(o=" line-numbers"),n=DOM.encode(n),l?(e.dom.setAttrib(l,"class","language-"+t+o),l.innerHTML=n,wrapCode(l),Prism.highlightElement(l.firstChild),e.selection.select(l)):(e.insertContent('<pre id="__new" class="language-'+t+o+'">'+n+"</pre>"),e.selection.select(e.$("#__new").removeAttr("id")[0]))})}function getSelectedCodeSample(e){var t=e.selection.getNode();return isCodeSample(t)?t:null}function getCurrentCode(e){var t=getSelectedCodeSample(e);return t?t.textContent:""}function getCurrentLanguage(e){var t,n=getSelectedCodeSample(e);return n?(t=n.className.match(/language-(\w+)/),t?t[1]:""):""}function getLineNumbers(e){var t=getSelectedCodeSample(e);return t?checkLineNumbers(t):!0}function openDialog(e){e.windowManager.open({title:"Insert/Edit code sample",minWidth:Math.min(DOM.getViewPort().w,e.getParam("codesample_dialog_width",800)),minHeight:Math.min(DOM.getViewPort().h,e.getParam("codesample_dialog_height",650)),layout:"flex",direction:"column",align:"stretch",body:[{type:"listbox",name:"language",label:"Language",maxWidth:200,value:getCurrentLanguage(e),values:getLanguages(e)},{type:"checkbox",name:"line_numbers",label:"Show line numbers",value:"true",checked:getLineNumbers(e)},{type:"textbox",name:"code",multiline:!0,spellcheck:!1,ariaLabel:"Code view",flex:1,style:"direction: ltr; text-align: left",classes:"monospace",value:getCurrentCode(e),autofocus:!0}],onSubmit:function(t){insertCodeSample(e,t.data.language,t.data.code,t.data.line_numbers)}})}var DOM=tinymce.dom.DOMUtils.DOM;tinymce.PluginManager.add("codesample",function(e,t){var n=e.$;e.on("PreProcess",function(e){n("pre[contenteditable=false]",e.node).filter(trimArg(isCodeSample)).each(function(e,t){var a=n(t),l=t.textContent;a.attr("class",n.trim(a.attr("class"))),a.removeAttr("contentEditable"),a.empty().append(n("<code></code>").each(function(){this.textContent=l}))})}),e.on("SetContent",function(){var t=n("pre"),a=t.filter(trimArg(isCodeSample)).filter(function(e,t){return"false"!==t.contentEditable});a.length&&e.undoManager.transact(function(){a.each(function(t,a){n(a).find("br").each(function(t,n){n.parentNode.replaceChild(e.getDoc().createTextNode("\n"),n)}),a.contentEditable=!1,a.innerHTML=e.dom.encode(a.textContent),a.className=n.trim(a.className)})}),t.each(function(e,t){t.getElementsByTagName("code").length||wrapCode(t),Prism.highlightElement(t.firstChild)})}),e.addCommand("codesample",function(){openDialog(e)}),e.addButton("codesample",{cmd:"codesample",title:"Insert/Edit code sample"})});