function wrapCode(e){e.innerHTML="<code>"+e.innerHTML+"</code>"}function checkLineNumbers(e){var t=e.className.match(/line-numbers/);return null!=t}function isCodeSample(e){return e&&"PRE"==e.nodeName&&-1!==e.className.indexOf("language-")}function trimArg(e){return function(t,n){return e(n)}}function getLanguages(e){var t=[{text:"HTML/XML",value:"markup"},{text:"JavaScript",value:"javascript"},{text:"CSS",value:"css"},{text:"PHP",value:"php"},{text:"Ruby",value:"ruby"},{text:"Python",value:"python"},{text:"Java",value:"java"},{text:"C",value:"c"},{text:"C#",value:"csharp"},{text:"C++",value:"cpp"}],n=e.settings.codesample_languages;return n?n:t}function insertCodeSample(e,t,n,a){e.undoManager.transact(function(){var i=getSelectedCodeSample(e),l="";a&&(l=" line-numbers"),n=DOM.encode(n),i?(e.dom.setAttrib(i,"class","language-"+t+l),i.innerHTML=n,wrapCode(i),Prism.highlightElement(i.firstChild),e.selection.select(i)):(e.insertContent('<pre id="__new" class="language-'+t+l+'">'+n+"</pre>"),e.selection.select(e.$("#__new").removeAttr("id")[0]))})}function getSelectedCodeSample(e){var t=e.selection.getNode();return isCodeSample(t)?t:null}function getCurrentCode(e){var t=getSelectedCodeSample(e);return t?t.textContent:""}function getCurrentLanguage(e){var t,n=getSelectedCodeSample(e);return n?(t=n.className.match(/language-(\w+)/),t?t[1]:""):""}function getLineNumbers(e){var t=getSelectedCodeSample(e);return t?checkLineNumbers(t):!0}function openDialog(e){e.windowManager.open({title:"Insert/Edit code sample",minWidth:Math.min(DOM.getViewPort().w,e.getParam("codesample_dialog_width",800)),minHeight:Math.min(DOM.getViewPort().h,e.getParam("codesample_dialog_height",650)),layout:"flex",direction:"column",align:"stretch",body:[{type:"listbox",name:"language",label:"Language",maxWidth:200,value:getCurrentLanguage(e),values:getLanguages(e)},{type:"checkbox",name:"line_numbers",label:"Show line numbers",value:"true",checked:getLineNumbers(e)},{type:"textbox",name:"code",multiline:!0,spellcheck:!1,ariaLabel:"Code view",flex:1,style:"direction: ltr; text-align: left",classes:"monospace",value:getCurrentCode(e),autofocus:!0}],onSubmit:function(t){insertCodeSample(e,t.data.language,t.data.code,t.data.line_numbers)}})}var DOM=tinymce.dom.DOMUtils.DOM,addedCss,addedInlineCss;tinymce.PluginManager.add("codesample",function(e,t){function n(){if((!e.inline||!addedInlineCss)&&(e.inline||!addedCss)){e.inline?addedInlineCss=!0:addedCss=!0;var n=e.dom.create("link",{rel:"stylesheet",href:t+"/css/prism.css"}),a=e.getDoc().getElementsByTagName("head")[0];a.insertBefore(n,a.getElementsByTagName("link")[0])}}var a=e.$;e.on("PreProcess",function(e){a("pre[contenteditable=false]",e.node).filter(trimArg(isCodeSample)).each(function(e,t){var n=a(t),i=t.textContent;n.attr("class",a.trim(n.attr("class"))),n.removeAttr("contentEditable"),n.empty().append(a("<code></code>").each(function(){this.textContent=i}))})}),e.on("SetContent",function(){var t=a("pre").filter(trimArg(isCodeSample)).filter(function(e,t){return"false"!==t.contentEditable});t.length&&e.undoManager.transact(function(){t.each(function(t,n){a(n).find("br").each(function(t,n){n.parentNode.replaceChild(e.getDoc().createTextNode("\n"),n)}),n.contentEditable=!1,n.innerHTML=e.dom.encode(n.textContent),wrapCode(n),Prism.highlightElement(n.firstChild),n.className=a.trim(n.className)})})}),e.addCommand("codesample",function(){openDialog(e)}),e.addButton("codesample",{cmd:"codesample",title:"Insert/Edit code sample"}),e.on("init",n)});